name: CI - Build and Push to ACR

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'Dockerfile'
      - '.github/workflows/ci.yaml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'Dockerfile'
  workflow_dispatch:

env:
  AZURE_ENV_NAME: ${{ secrets.AZURE_ENV_NAME != '' && secrets.AZURE_ENV_NAME || 'prod' }}
  IMAGE_TAG: ${{ github.sha }}
  IMAGE_TAG_LATEST: latest

jobs:
  build:
    runs-on: ubuntu-latest
    
    outputs:
      image-uri: ${{ steps.image-metadata.outputs.image-uri }}
      acr-login-server: ${{ steps.get-acr-info.outputs.acr-login-server }}
    
    steps:
      - name: âœ… Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'src/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: npm ci
        working-directory: src

      - name: ğŸ§ª Run tests
        run: npm test
        working-directory: src

      - name: ğŸ” Run linting
        continue-on-error: true
        run: npm run lint
        working-directory: src

      - name: ğŸ”§ Install Azure Developer CLI
        run: |
          curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: ğŸ” Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ” Get ACR information from Azure
        id: get-acr-info
        run: |
          # Get ACR name from Azure resources in the resource group
          RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"
          
          if [ -z "$RESOURCE_GROUP" ]; then
            echo "âš ï¸ AZURE_RESOURCE_GROUP not configured, skipping ACR operations"
            echo "acr-available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ” Looking for ACR in resource group: $RESOURCE_GROUP"
          
          # Get ACR name from resource group with error handling
          ACR_LIST_OUTPUT=$(az acr list --resource-group "$RESOURCE_GROUP" 2>&1)
          ACR_LIST_EXIT_CODE=$?
          
          if [ $ACR_LIST_EXIT_CODE -ne 0 ]; then
            echo "âš ï¸ Failed to list ACRs in resource group: $ACR_LIST_OUTPUT"
            echo "acr-available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          ACR_NAME=$(echo "$ACR_LIST_OUTPUT" | jq -r '.[0].name // empty')
          
          if [ -z "$ACR_NAME" ]; then
            echo "âš ï¸ No ACR found in resource group $RESOURCE_GROUP"
            echo "ğŸ’¡ Provision infrastructure with: azd provision"
            echo "acr-available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get ACR login server
          ACR_LOGIN_SERVER=$(az acr show --name "$ACR_NAME" --query loginServer -o tsv 2>&1)
          if [ $? -ne 0 ]; then
            echo "âš ï¸ Failed to get ACR login server: $ACR_LOGIN_SERVER"
            echo "acr-available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… Found ACR: $ACR_NAME"
          echo "âœ… ACR Login Server: $ACR_LOGIN_SERVER"
          echo "acr-available=true" >> $GITHUB_OUTPUT
          echo "acr-name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "acr-login-server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Build Docker image with azd package
        id: azd-package
        run: |
          # Use azd package to build the Docker image
          # This respects the azure.yaml configuration
          export AZURE_ENV_NAME="${{ env.AZURE_ENV_NAME }}"
          
          # Extract image name from azure.yaml
          IMAGE_NAME=$(grep '^name:' azure.yaml | head -1 | awk '{print $2}')
          if [ -z "$IMAGE_NAME" ]; then
            echo "âŒ Could not extract image name from azure.yaml"
            exit 1
          fi
          echo "ğŸ“¦ Image name from azure.yaml: $IMAGE_NAME"
          
          # Create azd environment if it doesn't exist
          azd env new "$AZURE_ENV_NAME" 2>&1 | grep -v "already exists" || azd env select "$AZURE_ENV_NAME"
          
          # Package the application (builds Docker image)
          echo "ğŸ—ï¸ Building Docker image with azd package..."
          azd package --output-path ./package-output
          
          # Verify the image was created and capture its actual tag
          # azd typically tags images as: {project-name}:{environment}-{timestamp}
          # We'll look for the image that was just built
          BUILT_IMAGE=$(docker images "$IMAGE_NAME" --format "{{.Repository}}:{{.Tag}}" | head -1)
          if [ -z "$BUILT_IMAGE" ]; then
            echo "âŒ Could not find built image with name: $IMAGE_NAME"
            docker images
            exit 1
          fi
          echo "âœ… Built image: $BUILT_IMAGE"
          
          echo "image-name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "built-image=$BUILT_IMAGE" >> $GITHUB_OUTPUT

      - name: ğŸ›¡ï¸ Run Trivy vulnerability scan on local image
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: '${{ steps.azd-package.outputs.built-image }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ğŸ“¤ Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

      - name: ğŸ³ Tag and push Docker image to ACR
        if: steps.get-acr-info.outputs.acr-available == 'true'
        id: docker-push
        run: |
          ACR_LOGIN_SERVER="${{ steps.get-acr-info.outputs.acr-login-server }}"
          ACR_NAME="${{ steps.get-acr-info.outputs.acr-name }}"
          IMAGE_NAME="${{ steps.azd-package.outputs.image-name }}"
          BUILT_IMAGE="${{ steps.azd-package.outputs.built-image }}"
          
          # Login to ACR
          echo "ğŸ” Logging in to ACR: $ACR_NAME"
          if ! az acr login --name "$ACR_NAME"; then
            echo "âŒ Failed to login to ACR. Ensure the service principal has AcrPush role."
            exit 1
          fi
          
          # Tag the image built by azd package
          REMOTE_IMAGE_SHA="$ACR_LOGIN_SERVER/$IMAGE_NAME:${{ env.IMAGE_TAG }}"
          REMOTE_IMAGE_LATEST="$ACR_LOGIN_SERVER/$IMAGE_NAME:${{ env.IMAGE_TAG_LATEST }}"
          
          echo "ğŸ·ï¸ Tagging image: $BUILT_IMAGE -> $REMOTE_IMAGE_SHA"
          docker tag "$BUILT_IMAGE" "$REMOTE_IMAGE_SHA"
          docker tag "$BUILT_IMAGE" "$REMOTE_IMAGE_LATEST"
          
          echo "ğŸ“¤ Pushing image: $REMOTE_IMAGE_SHA"
          docker push "$REMOTE_IMAGE_SHA"
          PUSH_DIGEST=$(docker push "$REMOTE_IMAGE_LATEST" 2>&1 | grep 'digest:' | awk '{print $3}')
          
          echo "âœ… Image pushed successfully"
          echo "image-digest=$PUSH_DIGEST" >> $GITHUB_OUTPUT

      - name: ğŸ“ Generate image metadata
        if: steps.get-acr-info.outputs.acr-available == 'true'
        id: image-metadata
        run: |
          ACR_LOGIN_SERVER="${{ steps.get-acr-info.outputs.acr-login-server }}"
          IMAGE_NAME="${{ steps.azd-package.outputs.image-name }}"
          IMAGE_URI="$ACR_LOGIN_SERVER/$IMAGE_NAME:${{ env.IMAGE_TAG }}"
          
          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "image-digest=${{ steps.docker-push.outputs.image-digest }}" >> $GITHUB_OUTPUT
          echo "pushed-at=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Display build summary
        if: steps.get-acr-info.outputs.acr-available == 'true'
        run: |
          echo "## ğŸ‰ CI Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image Name | \`${{ steps.azd-package.outputs.image-name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image URI | \`${{ steps.image-metadata.outputs.image-uri }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Digest | \`${{ steps.image-metadata.outputs.image-digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ACR Server | \`${{ steps.get-acr-info.outputs.acr-login-server }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Pushed At | ${{ steps.image-metadata.outputs.pushed-at }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

  notify-success:
    needs: build
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: âœ… CI Pipeline Succeeded
        run: |
          echo "ğŸ‰ CI Pipeline completed successfully!"
          if [ -n "${{ needs.build.outputs.image-uri }}" ]; then
            echo "Image URI: ${{ needs.build.outputs.image-uri }}"
            echo "ACR Server: ${{ needs.build.outputs.acr-login-server }}"
            echo "Image ready for deployment via CD pipeline"
          else
            echo "Docker image built and tested locally using azd package"
            echo "ACR push skipped - Azure resources not configured"
          fi

  notify-failure:
    needs: build
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: âŒ CI Pipeline Failed
        run: |
          echo "âŒ CI Pipeline failed!"
          exit 1
