name: CI - Build and Push to ACR

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'Dockerfile'
      - '.github/workflows/ci.yaml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'Dockerfile'
  workflow_dispatch:

env:
  AZURE_ENV_NAME: ${{ secrets.AZURE_ENV_NAME || 'prod' }}
  IMAGE_TAG: ${{ github.sha }}
  IMAGE_TAG_LATEST: latest

jobs:
  build:
    runs-on: ubuntu-latest
    
    outputs:
      image-uri: ${{ steps.image-metadata.outputs.image-uri }}
      acr-login-server: ${{ steps.get-acr-info.outputs.acr-login-server }}
    
    steps:
      - name: âœ… Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'src/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: npm ci
        working-directory: src

      - name: ğŸ§ª Run tests
        run: npm test
        working-directory: src

      - name: ğŸ” Run linting
        continue-on-error: true
        run: npm run lint
        working-directory: src

      - name: ğŸ”§ Install Azure Developer CLI
        run: |
          curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: ğŸ” Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ğŸ” Get ACR information from Azure
        id: get-acr-info
        run: |
          # Get ACR name from Azure resources in the resource group
          RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"
          
          if [ -z "$RESOURCE_GROUP" ]; then
            echo "âš ï¸ AZURE_RESOURCE_GROUP not configured, skipping ACR operations"
            echo "acr-available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get ACR name from resource group
          ACR_NAME=$(az acr list --resource-group "$RESOURCE_GROUP" --query "[0].name" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$ACR_NAME" ]; then
            echo "âš ï¸ No ACR found in resource group $RESOURCE_GROUP, skipping ACR operations"
            echo "acr-available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get ACR login server
          ACR_LOGIN_SERVER=$(az acr show --name "$ACR_NAME" --query loginServer -o tsv)
          
          echo "âœ… Found ACR: $ACR_NAME"
          echo "âœ… ACR Login Server: $ACR_LOGIN_SERVER"
          echo "acr-available=true" >> $GITHUB_OUTPUT
          echo "acr-name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "acr-login-server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: ğŸ—ï¸ Build Docker image with azd package
        id: azd-package
        run: |
          # Use azd package to build the Docker image
          # This respects the azure.yaml configuration
          export AZURE_ENV_NAME="${{ env.AZURE_ENV_NAME }}"
          
          # Create azd environment if it doesn't exist
          azd env new "$AZURE_ENV_NAME" 2>/dev/null || azd env select "$AZURE_ENV_NAME"
          
          # Package the application (builds Docker image)
          azd package --output-path ./package-output
          
          # Get the image name from azure.yaml service configuration
          IMAGE_NAME="self-healing-pipeline-demo"
          
          echo "image-name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: ğŸ›¡ï¸ Run Trivy vulnerability scan on local image
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: '${{ steps.azd-package.outputs.image-name }}:azd-deploy-${{ env.IMAGE_TAG }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ğŸ“¤ Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

      - name: ğŸ³ Tag and push Docker image to ACR
        if: steps.get-acr-info.outputs.acr-available == 'true'
        id: docker-push
        run: |
          ACR_LOGIN_SERVER="${{ steps.get-acr-info.outputs.acr-login-server }}"
          ACR_NAME="${{ steps.get-acr-info.outputs.acr-name }}"
          IMAGE_NAME="${{ steps.azd-package.outputs.image-name }}"
          
          # Login to ACR
          az acr login --name "$ACR_NAME"
          
          # Tag the image built by azd package
          LOCAL_IMAGE="$IMAGE_NAME:azd-deploy-${{ env.IMAGE_TAG }}"
          REMOTE_IMAGE_SHA="$ACR_LOGIN_SERVER/$IMAGE_NAME:${{ env.IMAGE_TAG }}"
          REMOTE_IMAGE_LATEST="$ACR_LOGIN_SERVER/$IMAGE_NAME:${{ env.IMAGE_TAG_LATEST }}"
          
          echo "Tagging image: $LOCAL_IMAGE -> $REMOTE_IMAGE_SHA"
          docker tag "$LOCAL_IMAGE" "$REMOTE_IMAGE_SHA"
          docker tag "$LOCAL_IMAGE" "$REMOTE_IMAGE_LATEST"
          
          echo "Pushing image: $REMOTE_IMAGE_SHA"
          docker push "$REMOTE_IMAGE_SHA"
          docker push "$REMOTE_IMAGE_LATEST"
          
          # Get image digest
          IMAGE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$REMOTE_IMAGE_SHA" | cut -d'@' -f2)
          
          echo "image-digest=$IMAGE_DIGEST" >> $GITHUB_OUTPUT

      - name: ğŸ“ Generate image metadata
        if: steps.get-acr-info.outputs.acr-available == 'true'
        id: image-metadata
        run: |
          ACR_LOGIN_SERVER="${{ steps.get-acr-info.outputs.acr-login-server }}"
          IMAGE_NAME="${{ steps.azd-package.outputs.image-name }}"
          IMAGE_URI="$ACR_LOGIN_SERVER/$IMAGE_NAME:${{ env.IMAGE_TAG }}"
          
          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "image-digest=${{ steps.docker-push.outputs.image-digest }}" >> $GITHUB_OUTPUT
          echo "pushed-at=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Display build summary
        if: steps.get-acr-info.outputs.acr-available == 'true'
        run: |
          echo "## ğŸ‰ CI Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image Name | \`${{ steps.azd-package.outputs.image-name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image URI | \`${{ steps.image-metadata.outputs.image-uri }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Digest | \`${{ steps.image-metadata.outputs.image-digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ACR Server | \`${{ steps.get-acr-info.outputs.acr-login-server }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Pushed At | ${{ steps.image-metadata.outputs.pushed-at }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

  notify-success:
    needs: build
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: âœ… CI Pipeline Succeeded
        run: |
          echo "ğŸ‰ CI Pipeline completed successfully!"
          if [ -n "${{ needs.build.outputs.image-uri }}" ]; then
            echo "Image URI: ${{ needs.build.outputs.image-uri }}"
            echo "ACR Server: ${{ needs.build.outputs.acr-login-server }}"
            echo "Image ready for deployment via CD pipeline"
          else
            echo "Docker image built and tested locally using azd package"
            echo "ACR push skipped - Azure resources not configured"
          fi

  notify-failure:
    needs: build
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: âŒ CI Pipeline Failed
        run: |
          echo "âŒ CI Pipeline failed!"
          exit 1
